{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h5 mb-0">Itinerary • {{ pkg.package_name }}</h1>
  <a href="/agency/{{ agency.registration_id }}/dashboard" class="btn btn-outline-secondary btn-sm">Dashboard</a>
</div>

{% if flashes %}
  {% for f in flashes %}
    <div class="alert alert-{{ 'danger' if f.type == 'error' else f.type }} alert-dismissible fade show" role="alert">
      {{ f.text }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">Itinerary — {{ pkg.days }} days</div>
      <div class="text-muted small">
        <span id="pct-text">0%</span> complete
      </div>
    </div>

    <div class="progress mb-3" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="height:8px;">
      <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
    </div>

    <!-- All-days form (one textarea per day) -->
    <form method="post" action="/package/{{ pkg.package_id }}/itinerary/wizard">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

      {# render textareas for each day; use name="notes" (multiple values) #}
      {% set total_days = pkg.days or 0 %}
      {% for day in range(1, total_days + 1) %}
        {% set existing = (itineraries_by_day[day] if itineraries_by_day is defined and day in itineraries_by_day else '') %}
        <div class="mb-3">
          <label class="form-label">Day {{ day }}</label>
          <textarea
            class="form-control itinerary-notes"
            name="notes"
            rows="4"
            data-day="{{ day }}"
            placeholder="Example: Arrival, transfers, rest, briefing, meals, ziyarat...">{{ existing }}</textarea>
          <div class="form-text text-muted">Tip: Keep each day concise. Visitors read this on mobile.</div>
        </div>
      {% endfor %}

      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit" name="nav" value="finish">Save &amp; Finish ✓</button>
        <a class="btn btn-outline-secondary" href="/agency/{{ agency.registration_id }}/dashboard">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
/* Live progress: count filled textareas and update bar/text */
function updateProgress() {
  const areas = document.querySelectorAll('.itinerary-notes');
  const total = areas.length;
  let filled = 0;
  areas.forEach(a => {
    if (a.value && a.value.trim().length > 0) filled += 1;
  });
  const pct = total ? Math.round((filled / total) * 100) : 0;
  const bar = document.getElementById('progress-bar');
  const pctText = document.getElementById('pct-text');
  if (bar) bar.style.width = pct + '%';
  if (pctText) pctText.textContent = pct + '%';
}

document.addEventListener('input', function (e) {
  if (e.target && e.target.classList.contains('itinerary-notes')) updateProgress();
});

// initial run
updateProgress();
</script>

{% endblock %}
