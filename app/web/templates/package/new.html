{% extends "base.html" %}
{% block content %}
<div class="container py-4" style="max-width: 820px;">
  <h1 class="h4 mb-3">Add Package</h1>

  {% if flashes %}
    {% for f in flashes %}
      <div class="alert alert-{{ 'danger' if f.type == 'error' else f.type }} alert-dismissible fade show" role="alert">
        {{ f.text }}
        <button type="button" class="btn btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" action="/package/new" class="card p-3">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="hidden" name="agency_id" value="{{ agency.registration_id }}">

    <!-- =============== Theme Picker =============== -->
    <style>
      .theme-grid{display:grid;grid-template-columns:1fr;gap:12px}
      @media (min-width:768px){.theme-grid{grid-template-columns:repeat(3,1fr)}}
      .theme-card{position:relative;border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;cursor:pointer;transition:box-shadow .15s, border-color .15s}
      .theme-card:hover{box-shadow:0 8px 24px rgba(2,6,23,.08)}
      .theme-card input[type="radio"]{position:absolute;inset:10px auto auto 10px}
      .theme-title{font-weight:700;font-size:.95rem;margin-left:24px}
      .theme-badge{display:inline-block;font-size:.7rem;padding:2px 6px;border-radius:999px;background:#f1f5f9;color:#0f172a;margin-left:6px}
      .theme-thumb{height:110px;border:1px dashed #e5e7eb;border-radius:10px;background:linear-gradient(180deg,#f8fafc,#eef2f7);display:flex;align-items:center;justify-content:center;font-size:.8rem;color:#64748b;margin-top:10px}
      .is-premium .theme-badge{background:linear-gradient(135deg,#9333ea,#2563eb);color:#fff}
      .theme-card:has(input:checked){border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
      .theme-desc{font-size:.8rem;color:#64748b;margin-top:8px;line-height:1.25rem}
    </style>

    <div class="mb-3">
      <label class="form-label d-block">Package Detail Theme *</label>
      <div class="theme-grid">
        <label class="theme-card">
          <input type="radio" name="detail_theme" value="basic" required checked>
          <span class="theme-title">Basic <span class="theme-badge">Default</span></span>
          <div class="theme-thumb">Clean 2-column, above-the-fold facts</div>
          <div class="theme-desc">Simple header, key price & dates on the left, quick highlights on the right.</div>
        </label>

        <label class="theme-card is-premium">
          <input type="radio" name="detail_theme" value="premium-aurora" required>
          <span class="theme-title">Aurora <span class="theme-badge">Premium</span></span>
          <div class="theme-thumb">Hero banner + stat chips + sticky CTA</div>
          <div class="theme-desc">Large hero with gradient overlay, stat chips, sticky inquiry button.</div>
        </label>

        <label class="theme-card is-premium">
          <input type="radio" name="detail_theme" value="premium-classic" required>
          <span class="theme-title">Classic <span class="theme-badge">Premium</span></span>
          <div class="theme-thumb">Tabbed sections + price cards</div>
          <div class="theme-desc">Tabs for Overview/Itinerary/Inclusions/FAQ + elegant price cards.</div>
        </label>
      </div>
      <div class="form-text mt-1">You can change this later while editing the package.</div>
    </div>
    <!-- ============================================ -->

    <!-- Package Type -->
    <div class="mb-3">
      <label class="form-label d-block">Package Type *</label>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="package_type" id="type_haj" value="haj" required>
        <label class="form-check-label" for="type_haj">Haj</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="radio" name="package_type" id="type_umrah" value="umrah" required>
        <label class="form-check-label" for="type_umrah">Umrah</label>
      </div>
      <div class="form-text">Choose exactly one.</div>
    </div>

    <!-- Basics -->
    <div class="mb-3">
      <label class="form-label">Package name *</label>
      <input class="form-control" type="text" name="package_name" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Package Class</label>
      <select class="form-select" name="package_class">
        <option value="">-- select class (optional) --</option>
        <option value="economy">Economy</option>
        <option value="business">Business</option>
        <option value="first">First Class</option>
      </select>
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Number of Days *</label>
        <input class="form-control" type="number" name="days" min="1" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Base Price (₹) *</label>
        <input class="form-control" type="number" step="0.01" name="price" min="0" required>
      </div>
      <div class="col-md-12">
        <label class="form-label">Variant prices</label>
        <div class="row g-2">
          <div class="col-md-4">
            <input class="form-control" type="number" step="0.01" name="price_double" placeholder="Double / Couple price">
          </div>
          <div class="col-md-4">
            <input class="form-control" type="number" step="0.01" name="price_triple" placeholder="Triple price">
          </div>
          <div class="col-md-4">
            <input class="form-control" type="number" step="0.01" name="price_quad" placeholder="Quad/Quint price">
          </div>
        </div>
        <input class="form-control mt-2" type="text" name="price_note" placeholder="Note / label (optional)">
      </div>
    </div>

    <div class="mb-3 mt-3">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="description" rows="3" placeholder="Add additional notes or conditions"></textarea>
    </div>

    <!-- Travel Month & Year -->
    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <label class="form-label">Travel Month</label>
        <select class="form-select" name="travel_month">
          <option value="">-- select month --</option>
          {% set month_names = ['January','February','March','April','May','June','July','August','September','October','November','December'] %}
          {% for i in range(1, 13) %}
            <option value="{{ i }}">{{ month_names[i-1] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Travel Year</label>
        <select class="form-select" name="travel_year">
          <option value="">-- select year --</option>
          {% for y in years %}
            <option value="{{ y }}">{{ y }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Airlines -->
    <div class="mb-3">
      <label class="form-label">Airlines (you can select multiple)</label>
      <select class="form-select" name="airline_ids" multiple size="6">
        {% for a in airlines %}
          <option value="{{ a.airline_id }}">{{ a.name }}</option>
        {% endfor %}
      </select>
    </div>

    <hr class="my-4">

    <!-- Flights -->
    <h2 class="h6 mb-3">Flights</h2>
    <div class="row">
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-body">
            <h3 class="h6">Onward</h3>
            <div class="mb-2">
              <label class="form-label">Date</label>
              <input class="form-control" type="date" name="onward_date">
            </div>
            <div class="mb-2">
              <label class="form-label">Type</label>
              <select class="form-select" name="onward_type">
                <option value="">-- select --</option>
                <option value="direct">Direct</option>
                <option value="via">Via</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Via (if any)</label>
              <input class="form-control" type="text" name="onward_via" placeholder="e.g., Doha">
            </div>
            <div class="mb-2">
              <label class="form-label">Airline</label>
              <input class="form-control" type="text" name="onward_airline" placeholder="e.g., Qatar Airways">
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-body">
            <h3 class="h6">Return</h3>
            <div class="mb-2">
              <label class="form-label">Date</label>
              <input class="form-control" type="date" name="return_date">
            </div>
            <div class="mb-2">
              <label class="form-label">Type</label>
              <select class="form-select" name="return_type">
                <option value="">-- select --</option>
                <option value="direct">Direct</option>
                <option value="via">Via</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Via (if any)</label>
              <input class="form-control" type="text" name="return_via" placeholder="e.g., Muscat">
            </div>
            <div class="mb-2">
              <label class="form-label">Airline</label>
              <input class="form-control" type="text" name="return_airline" placeholder="e.g., Oman Air">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =================== STAYS =================== -->
    <h2 class="h6 mb-3">Stay</h2>
    <div class="row">

      <!-- Mecca -->
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-body">
            <h3 class="h6">Mecca</h3>

            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Check-in</label>
                <input class="form-control" type="date" name="mecca_check_in">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Check-out</label>
                <input class="form-control" type="date" name="mecca_check_out">
              </div>
            </div>

            <!-- manual hotel -->
            <div class="mb-2">
              <label class="form-label">Hotel name</label>
              <div class="d-flex gap-2">
                <input
                  id="mecca_hotel"
                  class="form-control"
                  type="text"
                  name="mecca_hotel"
                  placeholder="Type new hotel OR choose below"
                >
                <select
                  id="mecca_hotel_city"
                  name="mecca_hotel_city"
                  class="form-select"
                  style="max-width: 140px;"
                >
                  <option value="Mecca" selected>Mecca</option>
                  <option value="Medinah">Medinah</option>
                </select>
              </div>
              <div class="form-text">Choose city only if you're adding a NEW hotel manually.</div>
            </div>

            <!-- saved hotels -->
            <div class="mb-2">
              <label class="form-label small text-muted">Or choose from saved Mecca hotels</label>
              <select id="mecca_hotel_select" class="form-select form-select-sm">
                <option value="">— Choose existing hotel —</option>
                {% for h in mecca_hotels %}
                  <option
                    value="{{ h.id }}"
                    data-name="{{ h.name }}"
                    data-link="{{ h.link or '' }}"
                    data-distance-km="{{ h.distance_km or '' }}"
                    data-rating="{{ h.rating or '' }}"
                  >
                    {{ h.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Hotel link (optional)</label>
              <input id="mecca_link" name="mecca_link" class="form-control" placeholder="https://">
            </div>

            <div class="mb-2">
              <label class="form-label">Hotel rating (stars)</label>
              <input id="mecca_rating" name="mecca_rating" class="form-control" placeholder="e.g., 5">
            </div>

            <div class="mb-2">
              <label class="form-label">Distance (km/meters) label</label>
              <input
                id="mecca_distance_text"
                name="mecca_distance_text"
                class="form-control"
                placeholder="e.g., 0.30 km from Haram"
              >
            </div>

            <!-- OR SIMILAR: Mecca -->
            <div class="mb-3">
              <label class="form-label">Similar Hotels (Mecca)</label>
              <select id="mecca_similar" name="mecca_similar" multiple>
                {% for h in mecca_hotels %}
                  <option value="{{ h.id }}">{{ h.name }}</option>
                {% endfor %}
              </select>
            </div>



          </div>
        </div>
      </div>

      <!-- Medinah -->
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-body">
            <h3 class="h6">Medinah</h3>

            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label">Check-in</label>
                <input class="form-control" type="date" name="med_check_in">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label">Check-out</label>
                <input class="form-control" type="date" name="med_check_out">
              </div>
            </div>

            <!-- manual hotel -->
            <div class="mb-2">
              <label class="form-label">Hotel name</label>
              <div class="d-flex gap-2">
                <input
                  id="med_hotel"
                  class="form-control"
                  type="text"
                  name="med_hotel"
                  placeholder="Type new hotel OR choose below"
                >
                <select
                  id="med_hotel_city"
                  name="med_hotel_city"
                  class="form-select"
                  style="max-width: 140px;"
                >
                  <option value="Medinah" selected>Medinah</option>
                  <option value="Mecca">Mecca</option>
                </select>
              </div>
              <div class="form-text">Choose city only if you're adding a NEW hotel manually.</div>
            </div>

            <!-- saved hotels -->
            <div class="mb-2">
              <label class="form-label small text-muted">Or choose from saved Medinah hotels</label>
              <select id="med_hotel_select" class="form-select form-select-sm">
                <option value="">— Choose existing hotel —</option>
                {% for h in medinah_hotels %}
                  <option
                    value="{{ h.id }}"
                    data-name="{{ h.name }}"
                    data-link="{{ h.link or '' }}"
                    data-distance-km="{{ h.distance_km or '' }}"
                    data-rating="{{ h.rating or '' }}"
                  >
                    {{ h.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Hotel link (optional)</label>
              <input id="med_link" name="med_link" class="form-control" placeholder="https://">
            </div>

            <div class="mb-2">
              <label class="form-label">Hotel rating (stars)</label>
              <input id="med_rating" name="med_rating" class="form-control" placeholder="e.g., 4">
            </div>

            <div class="mb-2">
              <label class="form-label">Distance (km/meters) label</label>
              <input
                id="med_distance_text"
                name="med_distance_text"
                class="form-control"
                placeholder="e.g., 0.20 km from Masjid an-Nabawi"
              >
            </div>

            <!-- OR SIMILAR: Medinah -->
            <div class="mb-3">
              <label class="form-label">Similar Hotels (Medinah)</label>
              <select id="medinah_similar" name="medinah_similar" multiple>
                {% for h in medinah_hotels %}
                  <option value="{{ h.id }}">{{ h.name }}</option>
                {% endfor %}
              </select>
            </div>



          </div>
        </div>
      </div>
    </div>

    <script>
  new SlimSelect({
    select: '#mecca_similar',
    placeholder: 'Search & select similar hotels...',
    allowDeselect: true,
    closeOnSelect: false
  });

  new SlimSelect({
    select: '#medinah_similar',
    placeholder: 'Search & select similar hotels...',
    allowDeselect: true,
    closeOnSelect: false
  });
</script>

    <!-- ============================================ -->

    <!-- Inclusions -->
    <h2 class="h6 mb-3">Inclusions</h2>
    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="incl_meals_enabled" name="incl_meals_enabled">
              <label class="form-check-label fw-semibold" for="incl_meals_enabled">Meals</label>
            </div>
            <input class="form-control mt-2" type="text" name="incl_meals_desc" placeholder="e.g., Breakfast & Dinner">
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="incl_laundry_enabled" name="incl_laundry_enabled">
              <label class="form-check-label fw-semibold" for="incl_laundry_enabled">Laundry</label>
            </div>
            <input class="form-control mt-2" type="text" name="incl_laundry_desc" placeholder="e.g., Alternate days">
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="incl_transport_enabled" name="incl_transport_enabled">
              <label class="form-check-label fw-semibold" for="incl_transport_enabled">Transport</label>
            </div>
            <input class="form-control mt-2" type="text" name="incl_transport_desc" placeholder="e.g., Airport transfers + Ziyarat">
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="incl_zamzam_enabled" name="incl_zamzam_enabled">
              <label class="form-check-label fw-semibold" for="incl_zamzam_enabled">Zam Zam</label>
            </div>
            <input class="form-control mt-2" type="text" name="incl_zamzam_desc" placeholder="e.g., 5 liters per pilgrim">
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="incl_welcome_kit_enabled" name="incl_welcome_kit_enabled">
              <label class="form-check-label fw-semibold" for="incl_welcome_kit_enabled">Welcome Kit</label>
            </div>
            <input class="form-control mt-2" type="text" name="incl_welcome_kit_desc" placeholder="e.g., Backpack, ID card, prayer mat">
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="incl_insurance_enabled" name="incl_insurance_enabled">
              <label class="form-check-label fw-semibold" for="incl_insurance_enabled">Insurance</label>
            </div>
            <input class="form-control mt-2" type="text" name="incl_insurance_desc" placeholder="e.g., Travel medical insurance included">
          </div>

          <div class="col-12">
            <label class="form-label mt-2">Other notes (optional)</label>
            <textarea class="form-control" name="incl_other" rows="2" placeholder="(optional — add any other inclusions or notes)"></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">Save & Next</button>
      <a href="/agency/{{ agency.registration_id }}/dashboard" class="btn btn-outline-secondary">Cancel</a>
    </div>
  </form>
</div>

<!-- ================= Similar Hotels Modal (shared) ================= -->
<div class="modal fade" id="similarHotelsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select Similar Hotels</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input id="similar_search" type="text" class="form-control form-control-sm mb-2" placeholder="Search hotel...">
        <div id="similarHotelsList"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-sm btn-primary" id="similarHotelsApplyBtn">
          Add selected
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ================= JS ================= -->
<script>
  // ----------------------------------------------------
  // 1) Existing: Autofill hotel fields from DB selects
  // ----------------------------------------------------
  function wireHotelSelect(selectId, nameInputId, linkId, distanceLabelId, ratingId, cityLockId) {
    const select = document.getElementById(selectId);
    if (!select) return;

    select.addEventListener("change", function () {
      const opt = this.selectedOptions[0];
      if (!opt || !opt.dataset) return;

      const name = opt.dataset.name || "";
      const link = opt.dataset.link || "";
      const distanceKm = opt.dataset.distanceKm || "";
      const rating = opt.dataset.rating || "";

      const nameInput = document.getElementById(nameInputId);
      const linkInput = document.getElementById(linkId);
      const distLabelInput = document.getElementById(distanceLabelId);
      const ratingInput = document.getElementById(ratingId);
      const citySelect = document.getElementById(cityLockId);

      if (nameInput) nameInput.value = name;
      if (linkInput) linkInput.value = link;
      if (ratingInput) ratingInput.value = rating;

      if (distLabelInput && distanceKm) {
        const cityLabel = selectId === "mecca_hotel_select" ? "Haram" : "Masjid an-Nabawi";
        distLabelInput.value = distanceKm + " km from " + cityLabel;
      }

      // lock city when choosing saved hotel
      if (citySelect) {
        citySelect.value = (selectId === "mecca_hotel_select") ? "Mecca" : "Medinah";
      }
    });
  }

  wireHotelSelect("mecca_hotel_select", "mecca_hotel", "mecca_link", "mecca_distance_text", "mecca_rating", "mecca_hotel_city");
  wireHotelSelect("med_hotel_select", "med_hotel", "med_link", "med_distance_text", "med_rating", "med_hotel_city");
</script>



{% endblock %}
