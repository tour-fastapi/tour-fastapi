{% extends "base.html" %}
{% block content %}

<!-- Main Content -->
<main class="flex-1 flex items-center justify-center px-4 py-8 md:py-12" style="min-height: calc(100vh - 400px);">
  <div class="w-full max-w-md">
    
    <!-- Header Section -->
    <div class="text-center mb-6 md:mb-8">
      <div 
        class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4"
        style="background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(145, 62%, 24%) 100%); color: white;">
        <i data-lucide="log-in" class="w-8 h-8"></i>
      </div>
      <h1 class="mb-2" style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700;">
        Welcome back
      </h1>
      <p class="text-sm md:text-base" style="color: hsl(var(--muted));">
        Sign in to your UmrahAdvisor account
      </p>
    </div>

    <!-- Flash Messages (Backend Alerts) -->
    {% if flashes %}
      <div id="flashMessages" class="mb-5">
        {% for f in flashes %}
          <div class="alert alert--{{ 'error' if f.type == 'error' else 'success' if f.type == 'success' else 'warning' if f.type == 'warning' else 'info' }}">
            <i data-lucide="{{ 'alert-circle' if f.type == 'error' else 'check-circle' if f.type == 'success' else 'alert-triangle' if f.type == 'warning' else 'info' }}" class="alert__icon"></i>
            <div class="alert__content">
              <div class="alert__title">{{ f.type|capitalize }}</div>
              <div class="alert__message">{{ f.text }}</div>
            </div>
            <button type="button" class="alert__close" onclick="closeFlashAlert(this)">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Login Form Card -->
    <div class="form-card">
      <form method="post" action="/login" id="loginForm" novalidate>
        
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
        
        <!-- Email Field -->
        <div class="form-group">
          <label for="email" class="form-label form-label--required">
            Email address
          </label>
          <div class="form-input-wrapper">
            <i data-lucide="mail" class="form-input-icon"></i>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input form-input--with-icon"
              placeholder="you@example.com"
              value="{{ email or '' }}"
              required
              autocomplete="email"
            />
          </div>
          <div class="invalid-feedback" style="display: none;">
            Please enter a valid email address
          </div>
        </div>

        <!-- Password Field -->
        <div class="form-group">
          <label for="password" class="form-label form-label--required">
            Password
          </label>
          <div class="form-input-wrapper form-input-wrapper--password">
            <i data-lucide="lock" class="form-input-icon"></i>
            <input
              type="password"
              id="password"
              name="password"
              class="form-input form-input--with-icon"
              placeholder="Enter your password"
              required
              autocomplete="current-password"
              minlength="8"
            />
            <button
              type="button"
              class="form-password-toggle"
              onclick="togglePasswordVisibility('password')"
              aria-label="Toggle password visibility"
            >
              <i data-lucide="eye" id="password-eye-icon"></i>
            </button>
          </div>
          <div class="invalid-feedback" style="display: none;">
            Password is required
          </div>
        </div>

        <!-- Forgot Password Link -->
        <div class="text-right mb-5" style="margin-top: -0.5rem;">
          <a 
            href="/forgot-password" 
            class="text-sm"
            style="color: hsl(var(--primary)); font-weight: 500; text-decoration: none; transition: color 0.2s;"
            onmouseover="this.style.color='hsl(145, 62%, 24%)'"
            onmouseout="this.style.color='hsl(var(--primary))'"
          >
            Forgot password?
          </a>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="form-submit-btn"
          id="loginBtn"
        >
          <span id="loginBtnText">Sign in</span>
          <span id="loginBtnLoader" style="display: none;">
            <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
            Signing in...
          </span>
        </button>

      </form>
    </div>

    <!-- Sign Up Link - Outside Card -->
    <div class="text-center mt-6">
      <p style="color: hsl(var(--muted)); font-size: 0.875rem;">
        New to UmrahAdvisor? 
        <a 
          href="/register" 
          style="color: hsl(var(--primary)); font-weight: 600; text-decoration: none; margin-left: 0.25rem;"
          onmouseover="this.style.textDecoration='underline'"
          onmouseout="this.style.textDecoration='none'"
        >
          Create an account
        </a>
      </p>
    </div>

  </div>
</main>

<!-- Form Validation & Interaction Script -->
<script>
  // ========================================================================
  // FORM VALIDATION
  // ========================================================================
  const loginForm = document.getElementById('loginForm');
  
  if (loginForm) {
    loginForm.addEventListener('submit', function(event) {
      event.preventDefault();
      
      // Get form fields
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      
      // Reset validation states
      [emailInput, passwordInput].forEach(input => {
        input.classList.remove('is-invalid', 'is-valid');
        const feedback = input.parentElement.parentElement.querySelector('.invalid-feedback');
        if (feedback) feedback.style.display = 'none';
      });
      
      let isValid = true;
      
      // Validate Email
      const emailValue = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (!emailValue) {
        emailInput.classList.add('is-invalid');
        const feedback = emailInput.parentElement.parentElement.querySelector('.invalid-feedback');
        if (feedback) {
          feedback.textContent = 'Email is required';
          feedback.style.display = 'block';
        }
        isValid = false;
      } else if (!emailRegex.test(emailValue)) {
        emailInput.classList.add('is-invalid');
        const feedback = emailInput.parentElement.parentElement.querySelector('.invalid-feedback');
        if (feedback) {
          feedback.textContent = 'Please enter a valid email address';
          feedback.style.display = 'block';
        }
        isValid = false;
      } else {
        emailInput.classList.add('is-valid');
      }
      
      // Validate Password
      const passwordValue = passwordInput.value;
      
      if (!passwordValue) {
        passwordInput.classList.add('is-invalid');
        const feedback = passwordInput.parentElement.parentElement.querySelector('.invalid-feedback');
        if (feedback) {
          feedback.textContent = 'Password is required';
          feedback.style.display = 'block';
        }
        isValid = false;
      } else if (passwordValue.length < 8) {
        passwordInput.classList.add('is-invalid');
        const feedback = passwordInput.parentElement.parentElement.querySelector('.invalid-feedback');
        if (feedback) {
          feedback.textContent = 'Password must be at least 8 characters';
          feedback.style.display = 'block';
        }
        isValid = false;
      } else {
        passwordInput.classList.add('is-valid');
      }
      
      // If valid, submit form with loading state
      if (isValid) {
        setButtonLoading(true);
        this.submit();
      }
    });
    
    // Clear validation on input
    ['email', 'password'].forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('input', function() {
          this.classList.remove('is-invalid', 'is-valid');
          const feedback = this.parentElement.parentElement.querySelector('.invalid-feedback');
          if (feedback) feedback.style.display = 'none';
        });
      }
    });
  }

  // ========================================================================
  // PASSWORD VISIBILITY TOGGLE
  // ========================================================================
  function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId + '-eye-icon');
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.setAttribute('data-lucide', 'eye-off');
    } else {
      input.type = 'password';
      icon.setAttribute('data-lucide', 'eye');
    }
    
    // Re-render lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  }

  // ========================================================================
  // BUTTON LOADING STATE
  // ========================================================================
  function setButtonLoading(isLoading) {
    const btn = document.getElementById('loginBtn');
    const btnText = document.getElementById('loginBtnText');
    const btnLoader = document.getElementById('loginBtnLoader');
    
    if (isLoading) {
      btn.disabled = true;
      btn.style.opacity = '0.7';
      btn.style.cursor = 'not-allowed';
      btnText.style.display = 'none';
      btnLoader.style.display = 'flex';
      btnLoader.style.alignItems = 'center';
      btnLoader.style.justifyContent = 'center';
      btnLoader.style.gap = '0.5rem';
      
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    } else {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      btnText.style.display = 'block';
      btnLoader.style.display = 'none';
    }
  }

  // ========================================================================
  // ALERT FUNCTIONS
  // ========================================================================
  function closeFlashAlert(button) {
    const alert = button.closest('.alert');
    if (alert) alert.style.display = 'none';
  }

  // ========================================================================
  // INITIALIZE
  // ========================================================================
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // Focus email field
    const emailInput = document.getElementById('email');
    if (emailInput && !emailInput.value) {
      emailInput.focus();
    }
  });
</script>

{% endblock %}