{% extends "base.html" %}
{% block content %}

<!-- Main Content -->
<main class="flex-1 flex items-center justify-center px-4 py-8 md:py-12" style="min-height: calc(100vh - 400px);">
  <div class="w-full max-w-md">
    
    <!-- Header Section -->
    <div class="text-center mb-6 md:mb-8">
      <div 
        class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4"
        style="background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(145, 62%, 24%) 100%); color: white;">
        <i data-lucide="key-round" class="w-8 h-8"></i>
      </div>
      <h1 class="mb-2" style="font-size: clamp(1.5rem, 4vw, 2rem); font-weight: 700;">
        Forgot password?
      </h1>
      <p class="text-sm md:text-base" style="color: hsl(var(--muted));">
        No worries, we'll send you reset instructions
      </p>
    </div>

    <!-- Flash Messages (Backend Alerts) -->
    {% if flashes %}
      <div id="flashMessages" class="mb-5">
        {% for f in flashes %}
          <div class="alert alert--{{ 'error' if f.type == 'error' else 'success' if f.type == 'success' else 'warning' if f.type == 'warning' else 'info' }}">
            <i data-lucide="{{ 'alert-circle' if f.type == 'error' else 'check-circle' if f.type == 'success' else 'alert-triangle' if f.type == 'warning' else 'info' }}" class="alert__icon"></i>
            <div class="alert__content">
              <div class="alert__title">{{ f.type|capitalize }}</div>
              <div class="alert__message">{{ f.text }}</div>
            </div>
            <button type="button" class="alert__close" onclick="closeFlashAlert(this)">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Forgot Password Form Card -->
    <div class="form-card">
      
      <!-- Info Box -->
      <div class="mb-5" style="background: hsl(var(--bg-secondary)); border: 1px solid hsl(var(--border)); border-radius: 0.75rem; padding: 1rem;">
        <p style="font-size: 0.875rem; line-height: 1.5; color: hsl(var(--fg)); margin: 0;">
          Enter your email and we'll send a password reset link if an account exists. For privacy, we won't disclose whether the email is registered.
        </p>
      </div>

      <form method="post" action="/forgot-password" id="forgotPasswordForm" novalidate>
        
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
        
        <!-- Email Field -->
        <div class="form-group">
          <label for="email" class="form-label form-label--required">
            Email address
          </label>
          <div class="form-input-wrapper">
            <i data-lucide="mail" class="form-input-icon"></i>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input form-input--with-icon"
              placeholder="you@example.com"
              value="{{ email or '' }}"
              required
              autocomplete="email"
            />
          </div>
          <div class="invalid-feedback" style="display: none;">
            Please enter a valid email address
          </div>
        </div>

        <!-- Submit Button -->
        <button
          type="submit"
          class="form-submit-btn"
          id="resetBtn"
        >
          <span id="resetBtnText">Send reset link</span>
          <span id="resetBtnLoader" style="display: none;">
            <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
            Sending...
          </span>
        </button>

      </form>
    </div>

    <!-- Back to Login Link - Outside Card -->
    <div class="text-center mt-6">
      <a 
        href="/login" 
        class="inline-flex items-center gap-2 text-sm font-medium"
        style="color: hsl(var(--muted)); text-decoration: none; transition: color 0.2s;"
        onmouseover="this.style.color='hsl(var(--primary))'"
        onmouseout="this.style.color='hsl(var(--muted))'"
      >
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Back to login
      </a>
    </div>

  </div>
</main>

<!-- Form Validation & Interaction Script -->
<script>
  // ========================================================================
  // FORM VALIDATION
  // ========================================================================
  const forgotPasswordForm = document.getElementById('forgotPasswordForm');
  
  if (forgotPasswordForm) {
    forgotPasswordForm.addEventListener('submit', function(event) {
      event.preventDefault();
      
      // Get form field
      const emailInput = document.getElementById('email');
      
      // Reset validation state
      emailInput.classList.remove('is-invalid', 'is-valid');
      const feedback = emailInput.parentElement.parentElement.querySelector('.invalid-feedback');
      if (feedback) feedback.style.display = 'none';
      
      let isValid = true;
      
      // Validate Email
      const emailValue = emailInput.value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      
      if (!emailValue) {
        emailInput.classList.add('is-invalid');
        if (feedback) {
          feedback.textContent = 'Email is required';
          feedback.style.display = 'block';
        }
        isValid = false;
      } else if (!emailRegex.test(emailValue)) {
        emailInput.classList.add('is-invalid');
        if (feedback) {
          feedback.textContent = 'Please enter a valid email address';
          feedback.style.display = 'block';
        }
        isValid = false;
      } else {
        emailInput.classList.add('is-valid');
      }
      
      // If valid, submit form with loading state
      if (isValid) {
        setButtonLoading(true);
        this.submit();
      }
    });
    
    // Clear validation on input
    const emailField = document.getElementById('email');
    if (emailField) {
      emailField.addEventListener('input', function() {
        this.classList.remove('is-invalid', 'is-valid');
        const feedback = this.parentElement.parentElement.querySelector('.invalid-feedback');
        if (feedback) feedback.style.display = 'none';
      });
    }
  }

  // ========================================================================
  // BUTTON LOADING STATE
  // ========================================================================
  function setButtonLoading(isLoading) {
    const btn = document.getElementById('resetBtn');
    const btnText = document.getElementById('resetBtnText');
    const btnLoader = document.getElementById('resetBtnLoader');
    
    if (isLoading) {
      btn.disabled = true;
      btn.style.opacity = '0.7';
      btn.style.cursor = 'not-allowed';
      btnText.style.display = 'none';
      btnLoader.style.display = 'flex';
      btnLoader.style.alignItems = 'center';
      btnLoader.style.justifyContent = 'center';
      btnLoader.style.gap = '0.5rem';
      
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    } else {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
      btnText.style.display = 'block';
      btnLoader.style.display = 'none';
    }
  }

  // ========================================================================
  // ALERT FUNCTIONS
  // ========================================================================
  function closeFlashAlert(button) {
    const alert = button.closest('.alert');
    if (alert) alert.style.display = 'none';
  }

  // ========================================================================
  // INITIALIZE
  // ========================================================================
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize lucide icons
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    
    // Focus email field
    const emailInput = document.getElementById('email');
    if (emailInput && !emailInput.value) {
      emailInput.focus();
    }
  });
</script>

{% endblock %}
