{% extends "base.html" %}
{% block title %}Discover Packages{% endblock %}
{% block content %}
{% import "shared/_macros.html" as ui %}

<main class="page">

<!-- ============================================================
  PAGE HEADER
============================================================ -->
<div class="listing-header">
  <div class="listing-header__container">
    <h1 class="listing-header__title">Find Your Perfect Umrah Package</h1>
    <p class="listing-header__subtitle">
      {% if packages_by_city %}
        Discover Umrah packages by city
      {% else %}
        No packages available yet
      {% endif %}
    </p>
  </div>
</div>

{% if packages_by_city and packages_by_city|length > 0 %}

  {# packages_by_city = [(city_name, [Package, Package...]), ...] #}
  {% for city, packages in packages_by_city %}

    {% if packages and packages|length > 0 %}
      <div class="listing-results">

        <!-- City Header -->
        <div class="group-header">
          <h3 class="group-header__title">
            {{ packages|length }} package{{ 's' if packages|length != 1 else '' }} in {{ city }}
          </h3>
        </div>

        {% for p in packages %}
          <div class="package-card">

            <!-- ============================================================
              BANNER
            ============================================================ -->
            {% set banner = p.banner_image if p.banner_image else "dynamic-tawaf-at-night.jpg" %}
            <div class="package-card__banner">
              <img
                src="/media/packages-banners/{{ banner }}"
                onerror="this.onerror=null;this.src='/media/packages-banners/dynamic-tawaf-at-night.jpg';"
                alt="{{ p.package_name }}"
                class="package-card__banner-image"
              />
              <div class="package-card__banner-gradient"></div>

              <div class="package-card__banner-content">

                <!-- Package Info -->
                <div class="package-card__info">

                  <div class="package-card__header">
                    <h3 class="package-card__name">{{ p.package_name }}</h3>

                    {% if p.price %}
                      <div class="package-card__price-box">
                        <div class="package-card__price">₹ {{ p.price }}</div>
                      </div>
                    {% endif %}
                  </div>

                  <!-- Meta -->
                  <p class="package-card__meta">
                    {% if p.package_class %}
                      <span class="package-card__category">{{ p.package_class|title }}</span>
                      <span class="package-card__meta-separator">•</span>
                    {% endif %}

                    {% if p.days %}
                      <span class="package-card__meta-item">
                        {{ p.days }} Days
                      </span>
                    {% endif %}
                  </p>

                  <!-- Travel Month / Year -->
                  {% if p.travel_month or p.travel_year %}
                    <div class="package-card__departure">
                      <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                      </svg>
                      <span>
                        Travel:
                        {% if p.travel_month %}{{ p.travel_month }}{% endif %}
                        {% if p.travel_year %}/{{ p.travel_year }}{% endif %}
                      </span>
                    </div>
                  {% endif %}

                </div>
              </div>
            </div>

            <!-- ============================================================
              FLIGHTS (only if exist)
            ============================================================ -->
            {% if p.flights and p.flights|length > 0 %}
              <div class="package-card__flights">
                <div class="package-card__flights-grid">
                  {% for f in p.flights %}
                    <div class="flight-detail">
                      <div class="flight-detail__label">{{ f.direction|upper }}</div>
                      <div class="flight-detail__content">
                        <div class="flight-detail__info">
                          <div class="flight-detail__airline">{{ f.airline_name }}</div>
                          <div class="flight-detail__type">
                            {% if f.via_city %}
                              Via from {{ f.via_city }}
                            {% else %}
                              Direct
                            {% endif %}
                          </div>



                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <!-- ============================================================
              HOTELS (only if exist)
            ============================================================ -->
            {% if p.stays and p.stays|length > 0 %}
              <div class="package-card__accommodation">
                <div class="package-card__accommodation-grid">
                  {% for s in p.stays %}
                    <div class="accommodation-detail">
                      <div class="accommodation-detail__label">{{ s.city|upper }}</div>
                      <div class="accommodation-detail__content">
                        <div class="accommodation-detail__info">
                          <div class="accommodation-detail__name">{{ s.hotel_name }}</div>
                          
                            {% if s.distance_m %}
                              <div class="accommodation-detail__distance">
                                {{ s.distance_m }}m from
                                {% if s.city and s.city|lower == "makkah" %}
                                  Haram
                                {% elif s.city and s.city|lower == "madinah" %}
                                  Masjid Nabawi
                                {% else %}
                                  City Center
                                {% endif %}
                              </div>
                            {% endif %}


                         

                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% endif %}

            <!-- ============================================================
              OPERATOR
            ============================================================ -->
            <div class="package-card__operator">
              <div class="package-card__operator-content">
                <div class="package-card__operator-info">
                  <div class="operator-avatar">
                    {{ ui.agency_badge(p.agency, 40, True) }}
                  </div>
                  <div class="operator-details-meta">
                    <div class="operator-details__name">
                      {{ p.agency.agencies_name }}
                    </div>
                    {% if p.agency.city or p.agency.country %}
                      <div class="operator-details__location">
                        {{ p.agency.city }}{% if p.agency.country %}, {{ p.agency.country }}{% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- ============================================================
              CTA
            ============================================================ -->
            <div class="package-card__footer">
              <a href="/packages/{{ p.package_id }}" class="btn btn-primary">
                View Package
              </a>
            </div>

          </div>
        {% endfor %}
      </div>
    {% endif %}

  {% endfor %}

{% else %}
  <div class="card empty">No packages available yet.</div>
{% endif %}

</main>
{% endblock %}
