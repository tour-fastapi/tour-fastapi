{% extends "base.html" %}
{% block title %}{{ city }} ‚Ä¢ Operators & Packages{% endblock %}
{% block content %}
{% import "shared/_macros.html" as ui %}
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b;
    --primary:#2563eb; --primary-600:#1d4ed8; --border:#e5e7eb;
    --radius:16px; --shadow:0 12px 32px rgba(2,6,23,.08);
  }
  body{background:var(--bg);}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap}
  .head h1{margin:0;font-size:1.6rem;font-weight:900;color:var(--text)}
  .pill{display:inline-block;background:linear-gradient(135deg,var(--primary),var(--primary-600));color:#fff;border-radius:999px;padding:6px 12px;font-size:.8rem;font-weight:700}

  .section{margin-top:22px}
  .section-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:12px;flex-wrap:wrap}
  .section-title{margin:0;font-size:1.25rem;font-weight:800;color:var(--text)}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-block;padding:8px 12px;border-radius:10px;text-decoration:none;border:1px solid var(--border)}
  .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn-outline{background:#fff;color:var(--primary);border-color:#c7d2fe}

  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;padding:14px}
  @media (max-width: 980px){ .grid3{grid-template-columns:repeat(2,1fr);} }
  @media (max-width: 680px){ .grid3{grid-template-columns:1fr;} }

  /* rows with badge + text */
  .rowline{display:flex;align-items:center;gap:12px}

  /* operator card */
  .agency{border:1px solid var(--border);border-radius:14px;padding:14px;background:#fff;transition:box-shadow .2s,border-color .2s,transform .08s}
  .agency:hover{border-color:#c7d2fe;box-shadow:0 16px 42px rgba(37,99,235,.12);transform:translateY(-1px)}
  .agency h3{margin:0 0 4px 0;font-size:1.08rem}
  .agency h3 a{text-decoration:none;color:#111827}
  .agency h3 a:hover{color:var(--primary)}
  .meta{color:#6b7280;font-size:.92rem}
  .desc{margin-top:8px;color:#1f2937;font-size:.95rem}
  .chip{display:inline-block;margin-top:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:.78rem;color:#374151;background:#fff;text-decoration:none}

  /* package card */
  .pkg{display:block;text-decoration:none;background:#fff;border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:box-shadow .2s,border-color .2s,transform .08s}
  .pkg:hover{border-color:#c7d2fe;box-shadow:0 16px 42px rgba(37,99,235,.12);transform:translateY(-1px)}
  .pkg-media{height:120px;background:linear-gradient(135deg,#e2e8f0,#dbeafe)}
  .pkg-body{padding:14px}
  .pkg-name{margin:0 0 2px 0;font-size:1.02rem;font-weight:800;color:var(--text);line-height:1.3}
  .pkg-sub{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .pkg-desc{color:#0f172a;font-size:.95rem;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
  .pkg-foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted);font-size:.92rem}
  .cta{color:var(--primary);font-weight:700}

  .empty{padding:36px;text-align:center;color:var(--muted)}

  /* Badge styles (shared with macro) */
  .agency-badge{
    --badge-size: 56px;
    width:var(--badge-size); height:var(--badge-size);
    display:inline-grid; place-items:center; overflow:hidden;
    border-radius:10px; background:#eef2ff; border:1px solid var(--border);
  }
  .agency-badge.rounded{ border-radius:50%; }
  .agency-badge-img{ width:100%; height:100%; object-fit:contain; background:#fff; padding:6px; }
  .agency-badge-fallback{
    display:grid; place-items:center; width:100%; height:100%;
    font-weight:800; color:#374151; letter-spacing:.6px; font-size:.95rem;
  }
</style>

<div class="wrap">

  <div class="head">
    <h1>{{ city }}</h1>
    <div class="pill">
      {{ (agencies|length if agencies else 0) }} operators ‚Ä¢
      {{ (packages|length if packages else 0) }} packages
    </div>
  </div>

  <!-- Operators section -->
  <div class="section">
    <div class="section-head">
      <h2 class="section-title">Operators in {{ city }}</h2>
      <div class="actions">
        <a class="btn btn-primary" href="/city/{{ city|urlencode }}/umrah_operators">View all operators</a>
      </div>
    </div>
    <div class="">
      {% if agencies and agencies|length > 0 %}
        <section class="operator-list">
          {% for a in agencies %}
             <a
              href="/umrah_operators/{{ a.registration_id }}"
              class="operator-card entity-card"
            >
              <!-- Avatar -->
              <div class="operator-avatar" data-tone="{{ (loop.index0 + (a.agencies_name|length)) % 12 }}">
                {{ ui.agency_badge(a, 56, True) }}
              </div>

              <!-- Content -->
              <div class="operator-body">
                <h2 class="operator-name">
                  {{ a.agencies_name }}
                </h2>

                <p class="operator-location">
                  {{ a.city or '-' }}, {{ a.country or '-' }}
                </p>

                {% if a.description %}
                  <p class="operator-description">
                    {{ a.description }}
                  </p>
                {% endif %}

                <div class="operator-meta-primary">
                  <span class="meta-item">
                    <span class="meta-icon">üì¶</span>
                    <span>3 upcoming packages</span>
                  </span>

                  <span class="meta-sep">‚Ä¢</span>

                  <span class="meta-item">
                    <span>Starting from ‚Çπ45,000</span>
                  </span>

                  <span class="meta-sep">‚Ä¢</span>

                  <span class="meta-item">
                    <span class="meta-icon">‚≠ê</span>
                    <span>4.6</span>
                  </span>
                </div>
                <div class="operator-meta-primary operator-meta-muted is-hidden">
                  <span>No upcoming packages</span>
                </div>
                <div class="operator-meta-secondary">
                  <span>In business since 2019</span>
                  <span class="meta-sep">‚Ä¢</span>
                  <span>120+ tours</span>
                  <span class="meta-sep">‚Ä¢</span>
                  <span>3,500+ pilgrims</span>
                </div>


                {% if a.min_package_price %}
                  <p class="operator-meta">
                    Packages from <strong>‚Çπ {{ a.min_package_price }}</strong>
                  </p>
                {% endif %}
              </div>
            </a>
          {% endfor %}
          </section>
      {% else %}
        <div class="empty">No operators found in {{ city }}.</div>
      {% endif %}
    </div>
  </div>

  <!-- Packages section -->
  <div class="section">
    <div class="section-head">
      <h2 class="section-title">Packages in {{ city }}</h2>
      <div class="actions">
        <a class="btn btn-primary" href="/city/{{ city|urlencode }}/umrah_packages">View all packages</a>
      </div>
    </div>
    <section class="package-list">
      {% if packages and packages|length > 0 %}
        
          {% for p in packages %}
            {% set ag = agency_by_id.get(p.registration_id) %}
            {% set href = "/umrah_packages/" ~ p.package_id %}
             <a class="package-card entity-card" href="{{ href }}">

  <!-- Left: placeholder avatar / image later -->
  <div
    class="package-avatar operator-avatar is-hidden"
    data-tone="{{ (loop.index0 + (ag.agencies_name|length if ag else 0)) % 12 }}"
  >
    {% if ag %}
      {{ ui.agency_badge(ag, 56, True) }}
    {% endif %}
  </div>

  <div class="package-body">
    <div class="package-banner">
      <img src="/media/packages-banners/haram-sharif.jpg" />
    </div>

    <!-- Top row: title + price -->
    <div class="package-top">
      <div class="package-top__left">
        <div class="package-title-row">
          <h2 class="package-name">{{ p.package_name }}</h2>

          <!-- Nudges next to title -->
          <div class="package-nudges-inline">
            <span class="nudge nudge--good">Refundable</span>
            <span class="nudge nudge--warn">Filling fast</span>
            <!-- only render 1‚Äì2 usually -->
          </div>
        </div>

        <div class="package-route-line">
          <span class="package-route">Mumbai ‚Üí Jeddah ‚Üí Mumbai</span>
          <span class="meta-sep">‚Ä¢</span>
          <span class="package-duration">10D / 9N</span>
        </div>
      </div>


      <div class="package-price">
        <div class="package-price__value">‚Çπ 45,000</div>
        <div class="package-price__label">Starting</div>
      </div>
    </div>

   

    

    <!-- Chips / inclusions -->
    <div class="package-meta">
      <span class="meta-chip">Direct Flight</span>
      <span class="meta-chip">Visa Included</span>
      <span class="meta-chip">Transfers</span>
      <span class="meta-chip">Breakfast</span>
    </div>

    
    <div class="package-rows">
      <!-- Onward -->
      <div class="package-row">
        <div class="package-row__label">Onward</div>
        <div class="package-row__main">
          <div class="package-row__icon" aria-hidden="true">‚úàÔ∏è</div>
          <div class="package-row__content">
            
            <div class="package-row__title">Saudia ‚Ä¢ 12 Jan 2026</div>
            <div class="package-row__meta">BOM ‚Üí JED ‚Ä¢ Direct</div>
          </div>
        </div>  
      </div>

      <!-- Return -->
      <div class="package-row">
        <div class="package-row__label">Return</div>
        <div class="package-row__main">
          <div class="package-row__icon" aria-hidden="true">üõ¨</div>
          <div class="package-row__content">
            
            <div class="package-row__title">Air India ‚Ä¢ 22 Jan 2026</div>
            <div class="package-row__meta">JED ‚Üí BOM ‚Ä¢ Via DEL</div>
          </div>
        </div>  
      </div>

      <!-- Operator -->
      <div class="package-row">
        <div class="package-row__label">Operator</div>
        <div class="package-row__main">

          <div class="package-row__icon" aria-hidden="true">üè∑Ô∏è</div>
          <div class="package-row__content">
            
            <div class="package-row__title">Al Abaya</div>
            <div class="package-row__meta">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 4.6 (120)</div>
          </div>
        </div>  
      </div>
    </div>




    <!-- Stay blocks -->
     <div class="package-stays is-hidden">
      <!-- Stay in Makkah -->
      <div class="stay-card">
        <div class="stay-thumb">M</div>

        <div class="stay-body">
          <div class="stay-label">Stay in Makkah</div>

          <div class="stay-primary">
            <span class="stay-hotel">Anjum Hotel</span>
            <span class="meta-sep">‚Ä¢</span>
            <span class="stay-nights">6 nights</span>
          </div>

          <div class="stay-sub">0.6 km from Haram</div>
        </div>
      </div>

      <!-- Stay in Madinah -->
      <div class="stay-card">
        <div class="stay-thumb">D</div>

        <div class="stay-body">
          <div class="stay-label">Stay in Madinah</div>

          <div class="stay-primary">
            <span class="stay-hotel">Province Al Sham</span>
            <span class="meta-sep">‚Ä¢</span>
            <span class="stay-nights">3 nights</span>
          </div>

          <div class="stay-sub">0.4 km from Masjid Nabawi</div>
        </div>
      </div>
    </div>

    


    <!-- Description -->
    {% if p.description %}
    <p class="package-description is-hidden">
      {{ p.description }}
    </p>
  {% endif %}

   

  </div>
</a>
          {% endfor %}
        
      {% else %}
        <div class="empty">No packages found in {{ city }}.</div>
      {% endif %}
      </section>
  </div>

</div>
{% endblock %}
