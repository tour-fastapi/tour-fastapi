{% extends "base.html" %}

{% block content %}
<main class="operator-details">

  {# ===========================
     Helper: Treat None / "" / "None" / "null" as empty
     =========================== #}
  {% macro is_present(v) -%}
    {%- if v is none -%}
      {{- false -}}
    {%- else -%}
      {%- set s = (v|string)|trim -%}
      {{- s != "" and s|lower != "none" and s|lower != "null" -}}
    {%- endif -%}
  {%- endmacro %}

  {# ===========================
     Helpers / flags
     =========================== #}
  {% set MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'] %}

  {% set loc_city = (branch.city if branch and is_present(branch.city) else agency.city) %}
  {% set loc_country = (branch.country if branch and is_present(branch.country) else agency.country) %}

  {% set has_any_stat = (
    agency.operating_since is not none or
    agency.num_umrah_tours is not none or
    agency.num_hajj_tours is not none or
    agency.num_pilgrims_sent is not none or
    is_present(agency.public_registration_code)
  ) %}

  {% set has_contact_person = branch and is_present(branch.contact_person) %}
  {% set has_contact_number = branch and is_present(branch.contact_number) %}
  {% set has_email = is_present(agency.agency_email) %}
  {% set has_links = is_present(agency.website_url) or is_present(agency.instagram_url) or is_present(agency.facebook_url) %}
  {% set has_any_contact = has_contact_person or has_contact_number or has_email or has_links %}

  <!-- ===========================
       BANNER
       =========================== -->
  <div class="operator-banner">
    <div class="operator-banner__content">
      <div class="operator-banner__container">

        <h1 class="operator-banner__title">{{ agency.agencies_name }}</h1>

        <!-- Location -->
        {% if is_present(loc_city) or is_present(loc_country) %}
        <div class="operator-banner__meta">
          <div class="operator-banner__location">
            <i data-lucide="map-pin" class="icon icon--sm"></i>
            <span>
              {{ loc_city if is_present(loc_city) else '' }}{% if is_present(loc_city) and is_present(loc_country) %}, {% endif %}{{ loc_country if is_present(loc_country) else '' }}
            </span>
          </div>
        </div>
        {% endif %}

        <!-- Stats -->
        {% if has_any_stat %}
        <div class="operator-banner__stats">

          {% if agency.num_umrah_tours is not none %}
          <div class="operator-banner__stat">
            <span class="operator-banner__stat-value">{{ agency.num_umrah_tours }}+</span>
            Umrah Tours
          </div>
          {% endif %}

          {% if agency.num_hajj_tours is not none %}
          <div class="operator-banner__stat">
            <span class="operator-banner__stat-value">{{ agency.num_hajj_tours }}+</span>
            Hajj Tours
          </div>
          {% endif %}

          {% if agency.num_pilgrims_sent is not none %}
          <div class="operator-banner__stat">
            <span class="operator-banner__stat-value">{{ agency.num_pilgrims_sent }}+</span>
            Pilgrims Served
          </div>
          {% endif %}

          {% if agency.operating_since is not none %}
          <div class="operator-banner__stat">
            Since <span class="operator-banner__stat-value">{{ agency.operating_since }}</span>
          </div>
          {% endif %}

          {# Reg no: only if present (not None/"null"/"none"/empty) #}
          {% if is_present(agency.public_registration_code) %}
          <div class="operator-banner__stat">
            Reg. <span class="operator-banner__stat-value">{{ agency.public_registration_code }}</span>
          </div>
          {% endif %}

        </div>
        {% endif %}

      </div>
    </div>
  </div>

  <!-- ===========================
       CONTACT STRIP
       =========================== -->
  {% if has_any_contact %}
  <div class="operator-contact">
    <div class="operator-contact__container">
      <div class="operator-contact__wrapper">

        <div class="operator-contact__links">

          {% if has_contact_person %}
          <span class="operator-contact__link">
            <i data-lucide="user" class="icon icon--sm icon--primary"></i>
            {{ branch.contact_person }}
          </span>
          {% endif %}

          {% if has_contact_number %}
          <a href="tel:{{ branch.contact_number }}" class="operator-contact__link">
            <i data-lucide="phone" class="icon icon--sm icon--primary"></i>
            {{ branch.contact_number }}
          </a>
          {% endif %}

          {% if has_email %}
          <a href="mailto:{{ agency.agency_email }}" class="operator-contact__link">
            <i data-lucide="mail" class="icon icon--sm icon--primary"></i>
            <span>{{ agency.agency_email }}</span>
          </a>
          {% endif %}

          {% if is_present(agency.website_url) %}
          <a href="{{ agency.website_url }}" target="_blank" rel="noopener noreferrer" class="operator-contact__link">
            <i data-lucide="globe" class="icon icon--sm icon--primary"></i>
            <span>{{ agency.website_url }}</span>
          </a>
          {% endif %}

          {# Instagram/Facebook: hide if None/"null"/"none"/empty #}
          {% if is_present(agency.instagram_url) %}
          <a href="{{ agency.instagram_url }}" target="_blank" rel="noopener noreferrer" class="operator-contact__link">
            <i data-lucide="instagram" class="icon icon--sm icon--primary"></i>
            <span>Instagram</span>
          </a>
          {% endif %}

          {% if is_present(agency.facebook_url) %}
          <a href="{{ agency.facebook_url }}" target="_blank" rel="noopener noreferrer" class="operator-contact__link">
            <i data-lucide="facebook" class="icon icon--sm icon--primary"></i>
            <span>Facebook</span>
          </a>
          {% endif %}

        </div>

        <div class="operator-contact__actions">
          {% if has_contact_number %}
            <a href="tel:{{ branch.contact_number }}" class="btn-primary operator-contact__button">
              Call Operator
            </a>
          {% else %}
            <button class="btn-primary operator-contact__button">Contact Operator</button>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
  {% endif %}

  <!-- ===========================
       OPERATOR PACKAGES
       =========================== -->
  <div class="operator-packages">
    <div class="operator-packages__container">

      <div class="operator-packages__header">
        <h2 class="operator-packages__title">Available Packages</h2>
        {% if packages %}
          <span class="operator-packages__count">{{ packages|length }} package{{ 's' if packages|length != 1 else '' }}</span>
        {% endif %}
      </div>

      {% if packages %}
      <div class="operator-packages__list">

        {% for p in packages %}
        <a class="operator-package-card" href="/packages/{{ p.package_id }}">
          <div class="operator-package-card__inner">

            {# Month + Year #}
            {% set month_ok = (p.travel_month is not none and p.travel_month|int >= 1 and p.travel_month|int <= 12) %}
            {% set year_ok = (p.travel_year is not none) %}
            {% if month_ok or year_ok %}
            <div class="operator-package-card__date">
              <div class="operator-package-card__date-month">
                {% if month_ok %}{{ MONTHS[p.travel_month|int - 1] }}{% endif %}
                {% if month_ok and year_ok %} {% endif %}
                {% if year_ok %}{{ p.travel_year }}{% endif %}
              </div>
            </div>
            {% endif %}

            <div class="operator-package-card__content">
              <h3 class="operator-package-card__name">{{ p.package_name }}</h3>

              <div class="operator-package-card__meta">
                {% if is_present(p.package_class) %}
                  <span class="operator-package-card__badge">
                    {{ p.package_class|lower }}
                  </span>
                {% endif %}

                {% if p.days %}
                  <span>{{ p.days }} day{{ 's' if p.days != 1 else '' }}</span>
                {% endif %}
              </div>

              {% if p.price is not none %}
              <div class="operator-package-card__price">
                â‚¹{{ '%.2f'|format(p.price) }}
              </div>
              {% endif %}
            </div>

          </div>
        </a>
        {% endfor %}

      </div>
      {% else %}
      <div class="operator-packages__empty">
        No packages available.
      </div>
      {% endif %}

    </div>
  </div>

  <!-- ===========================
       ABOUT
       =========================== -->
  <div class="operator-about">
    <div class="operator-about__container">
      <h2 class="operator-about__title">About {{ agency.agencies_name }}</h2>

      {% if is_present(agency.description) %}
        <p class="operator-about__description">{{ agency.description }}</p>
      {% else %}
        <p class="operator-about__empty">No description available.</p>
      {% endif %}
    </div>
  </div>

</main>
{% endblock %}
