{% extends "base.html" %}
{% block title %}Packages in {{ city }}{% endblock %}
{% block content %}
{% import "shared/_macros.html" as ui %}

<main class="page">

<!-- ===================== PAGE HEADER ===================== -->
<div class="listing-header">
  <div class="listing-header__container">
    <h1 class="listing-header__title">Umrah Packages in {{ city }}</h1>
    <p class="listing-header__subtitle">
      {{ count }} Umrah package{{ 's' if count != 1 else '' }} departing from {{ city }}
    </p>
  </div>
</div>

<!-- ===================== RESULTS ===================== -->
{% if packages and packages|length > 0 %}
<div class="listing-results">
  <div class="listing-cards">

  {% for p in packages %}
    {% set ag = agency_by_id.get(p.registration_id) %}
    {% set banner = p.banner_image or "dynamic-tawaf-at-night.jpg" %}

    <div class="package-card">

      <!-- ===================== BANNER ===================== -->
      <div class="package-card__banner">
        <img
          src="/media/packages-banners/{{ banner }}"
          onerror="this.onerror=null;this.src='/media/packages-banners/dynamic-tawaf-at-night.jpg';"
          alt="{{ p.package_name }}"
          class="package-card__banner-image"
        />
        <div class="package-card__banner-gradient"></div>

        <div class="package-card__banner-content">
          <div class="package-card__info">

            <div class="package-card__header">
              <h3 class="package-card__name">{{ p.package_name }}</h3>

              {% if p.price is not none %}
                {# ✅ Currency per operator (by package.registration_id) #}
                {% set c = currency_by_agency_id.get(p.registration_id, {}) %}
                {% set sym = c.get("currency_symbol") %}
                {% set pos = c.get("currency_position") %}
                {% set code = c.get("currency_code") %}

                <div class="package-card__price-box">
                  <div class="package-card__price">
                    {{ format_money(p.price, sym, pos, code) }}
                  </div>
                </div>
              {% endif %}
            </div>

            <!-- ===================== META ===================== -->
            <p class="package-card__meta">
              {% if p.package_class %}
                <span class="package-card__category">{{ p.package_class|title }}</span>
                <span class="package-card__meta-separator">•</span>
              {% endif %}

              {% if p.days %}
                <span>{{ p.days }} Days</span>
              {% endif %}
            </p>

            <!-- ===================== TRAVEL DATE ===================== -->
            {% if p.travel_month or p.travel_year %}
            <div class="package-card__departure">
              <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              <span>
                Travel:
                {% if p.travel_month %}{{ p.travel_month }}{% endif %}
                {% if p.travel_year %}/{{ p.travel_year }}{% endif %}
              </span>
            </div>
            {% endif %}

          </div>
        </div>
      </div>

      <!-- ===================== FLIGHTS ===================== -->
      {% if p.flights and p.flights|length > 0 %}
      <div class="package-card__flights">
        <div class="package-card__flights-grid">

          {% for f in p.flights %}
          <div class="flight-detail">
            <div class="flight-detail__label">{{ f.direction|upper }}</div>
            <div class="flight-detail__content">
              <div class="flight-detail__info">
                <div class="flight-detail__airline">
                  {{ f.airline_name }}
                </div>

                <div class="flight-detail__type">
                  {% if f.via_city %}
                    Via from {{ f.via_city }}
                  {% else %}
                    Direct
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}

        </div>
      </div>
      {% endif %}

      <!-- ===================== ACCOMMODATION ===================== -->
      {% if p.stays and p.stays|length > 0 %}
      <div class="package-card__accommodation">
        <div class="package-card__accommodation-grid">

          {% for s in p.stays %}
          <div class="accommodation-detail">
            <div class="accommodation-detail__label">{{ s.city|upper }}</div>
            <div class="accommodation-detail__content">
              <div class="accommodation-detail__info">

                <div class="accommodation-detail__name">
                  {{ s.hotel_name }}
                </div>

                {% if s.distance_m %}
                <div class="accommodation-detail__distance">
                  {{ s.distance_m }}m from
                  {% if s.city and s.city|lower == "makkah" %}
                    Haram
                  {% elif s.city and s.city|lower == "madinah" %}
                    Masjid Nabawi
                  {% else %}
                    City Center
                  {% endif %}
                </div>
                {% endif %}

              </div>
            </div>
          </div>
          {% endfor %}

        </div>
      </div>
      {% endif %}

      <!-- ===================== OPERATOR ===================== -->
      {% if ag %}
      <div class="package-card__operator">
        <div class="package-card__operator-content">
          <div class="package-card__operator-info">

            <div class="operator-avatar">
              {{ ui.agency_badge(ag, 40, True) }}
            </div>

            <div class="operator-details">
              <div class="operator-details__name">
                {{ ag.agencies_name }}
              </div>

              {% if ag.city or ag.country %}
              <div class="operator-details__location">
                {{ ag.city }}{% if ag.country %}, {{ ag.country }}{% endif %}
              </div>
              {% endif %}
            </div>

          </div>
        </div>
      </div>
      {% endif %}

      <!-- ===================== CTA ===================== -->
      <div class="package-card__footer">
        <a href="/packages/{{ p.package_id }}" class="btn btn-primary">
          View Package
        </a>
      </div>

    </div>
  {% endfor %}

  </div>
</div>
{% else %}
<div class="empty-state">No packages found in {{ city }}.</div>
{% endif %}

</main>
{% endblock %}
